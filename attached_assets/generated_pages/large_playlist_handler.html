<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>ScheduleFlow - Large Playlist Optimizer</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #000000 0%, #000000 50%, #000000 100%);
            color: ##00ff00;
            padding: 70px 20px 20px 20px;
        }

        /* TOP NAVIGATION */
        .top-nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #000000;
            border-bottom: 2px solid rgba(0, 255, 0, 0.3);
            padding: 10px 20px;
            z-index: 10000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-nav-bar a {
            color: ##00ff00;
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .top-nav-bar a:hover {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .top-nav-bar .nav-logo {
            color: #00ff00;
            font-weight: bold;
        }

        .top-nav-bar .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #00ff00, #ffff00);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            transform: translateY(-2px);
        }
        
        h1 {
            flex: 1;
            font-size: 1.8em;
            background: linear-gradient(135deg, #00ff00, #ffff00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(0, 255, 0,0.2);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #00ff00;
            font-size: 1.2em;
        }
        
        .video-player {
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        input, textarea, select {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(0, 255, 0,0.3);
            color: ##00ff00;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0,0.3);
        }
        
        button {
            background: linear-gradient(135deg, #00ff00, #ffff00);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
            transform: translateY(-2px);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat {
            background: rgba(0, 255, 0,0.1);
            border: 1px solid rgba(0, 255, 0,0.3);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.85em;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #00ff00;
            font-family: monospace;
        }
        
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            background: linear-gradient(135deg, rgba(0, 255, 0,0.1), rgba(255, 255, 0,0.1));
            border: 1px solid rgba(0, 255, 0,0.3);
            color: ##00ff00;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .preset-btn:hover {
            background: linear-gradient(135deg, rgba(0, 255, 0,0.2), rgba(255, 255, 0,0.2));
            border-color: #00ff00;
        }
        
        .config-section {
            margin-bottom: 20px;
        }
        
        .config-section label {
            display: block;
            margin-bottom: 8px;
            color: #00ff00;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .range-control {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="range"] {
            flex: 1;
        }
        
        .range-value {
            min-width: 60px;
            text-align: right;
            font-family: monospace;
            color: #00ff00;
        }
        
        .output {
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(0, 255, 0,0.2);
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            color: #00ff00;
            margin-bottom: 20px;
        }
        
        .benchmark {
            background: rgba(255,0,0,0.05);
            border-left: 3px solid #ff3333;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .benchmark-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .benchmark-metric {
            color: #aaa;
        }
        
        .benchmark-value {
            font-weight: 700;
            color: #00ff00;
            font-family: monospace;
        }
        
        .alert {
            background: rgba(255,200,0,0.1);
            border-left: 3px solid #ffcc00;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #ffdd99;
        }
    </style>
</head>
<body>
    <nav class="top-nav-bar">
        <a href="index.html" class="nav-logo">üé¨ ScheduleFlow</a>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="m3u_scheduler.html">Scheduler</a>
            <a href="simple_player.html">Player</a>
            <a href="demo.html">Demo</a>
            <a href="interactive_hub.html">Dashboard</a>
        <a href="file_manager.html">File Manager</a>
            <a href="large_playlist_handler.html" style="color: #00ff00; border-bottom: 2px solid #00ff00;">Large Playlists</a>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>Large Playlist Optimizer</h1>
        </div>
        
        <div class="grid">
            <!-- Player Section -->
            <div class="card">
                <h2>Test Player</h2>
                <div class="video-player">
                    <video id="video" controls playsinline></video>
                </div>
                
                <div class="controls">
                    <input type="file" id="fileInput" accept="*" 
                           onchange="handleFileUpload(event)"
                           style="margin-bottom: 10px; width: 100%;">
                    <textarea id="playlistUrl" 
                              style="flex: 1; height: 60px;" 
                              placeholder="Paste M3U, JSON, XML, or any URL-containing file content here...">https://example.com/large-playlist.m3u8</textarea>
                </div>
                
                <button onclick="loadPlaylist()">Load Playlist</button>
                <button onclick="extractLinksFromInput()" style="margin-left: 10px; background: #ffaa00; color: #000;">Extract Links</button>
                
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 10px; color: #00ff00;">Player Status</h3>
                    <div id="status" style="font-family: monospace; font-size: 0.85em; color: #aaa;">Ready</div>
                </div>
            </div>
            
            <!-- Configuration Section -->
            <div class="card">
                <h2>Optimizer Settings</h2>
                
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="applyPreset('live')">Live Stream</button>
                    <button class="preset-btn" onclick="applyPreset('vod')">VOD Large</button>
                    <button class="preset-btn" onclick="applyPreset('mobile')">Mobile</button>
                    <button class="preset-btn" onclick="applyPreset('highbw')">High BW</button>
                </div>
                
                <div class="stats">
                    <div class="stat">
                        <div class="stat-label">Buffer (s)</div>
                        <div class="stat-value" id="bufferVal">30</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Back Buffer (s)</div>
                        <div class="stat-value" id="backBufVal">60</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Memory Est</div>
                        <div class="stat-value" id="memEst">~150MB</div>
                    </div>
                    <div class="stat">
                        <div class="stat-label">Startup (ms)</div>
                        <div class="stat-value" id="startupEst">~1000ms</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Configuration Details -->
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card">
                <h2>Advanced Configuration</h2>
                
                <div class="config-section">
                    <label>Max Forward Buffer Length (seconds)</label>
                    <div class="range-control">
                        <input type="range" id="maxBuffer" min="10" max="120" value="30" oninput="updateConfig()">
                        <span class="range-value" id="maxBufferDisplay">30s</span>
                    </div>
                </div>
                
                <div class="config-section">
                    <label>Back Buffer Eviction (seconds)</label>
                    <div class="range-control">
                        <input type="range" id="backBuffer" min="30" max="300" value="60" oninput="updateConfig()">
                        <span class="range-value" id="backBufferDisplay">60s</span>
                    </div>
                </div>
                
                <div class="config-section">
                    <label>Live Sync Segments</label>
                    <div class="range-control">
                        <input type="range" id="liveSync" min="1" max="10" value="3" oninput="updateConfig()">
                        <span class="range-value" id="liveSyncDisplay">3</span>
                    </div>
                </div>
                
                <div class="config-section">
                    <label>Initial Manifest Size (segments)</label>
                    <div class="range-control">
                        <input type="range" id="initialSize" min="3" max="30" value="5" oninput="updateConfig()">
                        <span class="range-value" id="initialSizeDisplay">5</span>
                    </div>
                </div>
                
                <button onclick="copyConfig()" style="width: 100%; margin-top: 15px;">Copy Configuration</button>
            </div>
        </div>
        
        <!-- Performance Benchmarks -->
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card">
                <h2>Performance Targets & Benchmarks</h2>
                
                <div class="alert">
                    <strong>‚ö†Ô∏è Large Playlist Warning:</strong> Playlists with 1000+ segments can cause memory issues if not optimized. Use sliding windows on the server side (keep only last 300-500 segments).
                </div>
                
                <div class="benchmark">
                    <div class="benchmark-item">
                        <span class="benchmark-metric">Playlist Size Limit</span>
                        <span class="benchmark-value">< 50 MB</span>
                    </div>
                    <div class="benchmark-item">
                        <span class="benchmark-metric">Memory Usage</span>
                        <span class="benchmark-value">< 200 MB</span>
                    </div>
                    <div class="benchmark-item">
                        <span class="benchmark-metric">Startup Latency</span>
                        <span class="benchmark-value">< 1000 ms</span>
                    </div>
                    <div class="benchmark-item">
                        <span class="benchmark-metric">CPU Per Stream</span>
                        <span class="benchmark-value">< 20%</span>
                    </div>
                    <div class="benchmark-item">
                        <span class="benchmark-metric">Safe Concurrency</span>
                        <span class="benchmark-value">5-10 streams</span>
                    </div>
                </div>
                
                <h3 style="color: #00ff00; margin-top: 20px; margin-bottom: 10px;">Current Configuration</h3>
                <div id="currentConfig" class="output"></div>
            </div>
        </div>
        
        <!-- Implementation Guide -->
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card">
                <h2>Implementation Guide</h2>
                
                <h3 style="color: #00ff00; margin-top: 15px; margin-bottom: 10px;">Server-Side (FFmpeg)</h3>
                <div class="output">ffmpeg -i input.ts \
  -hls_time 4 \
  -hls_list_size 300 \
  -hls_flags delete_segments \
  output.m3u8</div>
                
                <h3 style="color: #00ff00; margin-top: 15px; margin-bottom: 10px;">Client-Side (HLS.js)</h3>
                <div class="output" id="hlsJsCode"></div>
                
                <h3 style="color: #00ff00; margin-top: 15px; margin-bottom: 10px;">Recommended Presets</h3>
                
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="border-bottom: 1px solid rgba(0, 255, 0,0.2);">
                            <th style="text-align: left; padding: 10px; color: #00ff00;">Use Case</th>
                            <th style="text-align: left; padding: 10px; color: #00ff00;">Max Buffer</th>
                            <th style="text-align: left; padding: 10px; color: #00ff00;">Back Buffer</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="border-bottom: 1px solid rgba(0, 255, 0,0.1);">
                            <td style="padding: 10px;">Live Streams</td>
                            <td style="padding: 10px;">20s</td>
                            <td style="padding: 10px;">45s</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(0, 255, 0,0.1);">
                            <td style="padding: 10px;">VOD Large (500+ seg)</td>
                            <td style="padding: 10px;">60s</td>
                            <td style="padding: 10px;">120s</td>
                        </tr>
                        <tr style="border-bottom: 1px solid rgba(0, 255, 0,0.1);">
                            <td style="padding: 10px;">Mobile/Low BW</td>
                            <td style="padding: 10px;">15s</td>
                            <td style="padding: 10px;">30s</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">High Bandwidth</td>
                            <td style="padding: 10px;">90s</td>
                            <td style="padding: 10px;">180s</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Helper: Decode URL-encoded filename to readable title
        function extractTitle(url) {
            try {
                const filename = url.split('/').pop() || 'Playlist';
                let decoded = decodeURIComponent(filename);
                decoded = decoded.replace(/\.(mp4|mkv|avi|webm|m3u8|mov|flv|wmv|m3u|json|xml|txt|ts)$/i, '').trim();
                decoded = decoded.replace(/[_-]/g, ' ').substring(0, 80);
                return decoded || 'Playlist';
            } catch (e) {
                return url.split('/').pop().substring(0, 80) || 'Playlist';
            }
        }

        // Parse ANY file format and extract URLs
        function parseFileContent(content) {
            const urls = [];
            const lines = content.split('\n');
            
            // Try M3U format first
            const isMPlus = content.includes('#EXTM3U');
            if (isMPlus) {
                let i = 0;
                while (i < lines.length) {
                    const line = lines[i].trim();
                    if (line.startsWith('#EXTINF:')) {
                        const nextLine = lines[i + 1]?.trim();
                        if (nextLine && (nextLine.startsWith('http://') || nextLine.startsWith('https://'))) {
                            urls.push(nextLine);
                            i++;
                        }
                    }
                    i++;
                }
                return urls;
            }
            
            // Try JSON format
            try {
                const json = JSON.parse(content);
                const extractUrls = (obj) => {
                    if (Array.isArray(obj)) {
                        obj.forEach(item => extractUrls(item));
                    } else if (typeof obj === 'object' && obj !== null) {
                        Object.values(obj).forEach(val => {
                            if (typeof val === 'string' && (val.startsWith('http://') || val.startsWith('https://'))) {
                                if (!urls.includes(val)) urls.push(val);
                            } else if (typeof val === 'object') {
                                extractUrls(val);
                            }
                        });
                    }
                };
                extractUrls(json);
                if (urls.length > 0) return urls;
            } catch (e) {}
            
            // Try XML format
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(content, 'text/xml');
                const allElements = xmlDoc.getElementsByTagName('*');
                for (let elem of allElements) {
                    for (let attr of elem.attributes || []) {
                        const val = attr.value;
                        if (val.startsWith('http://') || val.startsWith('https://')) {
                            if (!urls.includes(val)) urls.push(val);
                        }
                    }
                    if (elem.textContent && (elem.textContent.includes('http://') || elem.textContent.includes('https://'))) {
                        const matches = elem.textContent.match(/https?:\/\/[^\s<>"{}|\\^`\[\]]*[^\s<>"{}|\\^`\[\],.:;!?()\]]/g) || [];
                        matches.forEach(url => {
                            if (!urls.includes(url)) urls.push(url);
                        });
                    }
                }
                if (urls.length > 0) return urls;
            } catch (e) {}
            
            // Fallback: Extract all HTTP/HTTPS URLs from any text content
            const matches = content.match(/https?:\/\/[^\s<>"{}|\\^`\[\]]*[^\s<>"{}|\\^`\[\],.:;!?()\]]/g) || [];
            matches.forEach(url => {
                if (!urls.includes(url)) urls.push(url);
            });
            
            return urls;
        }

        // Handle file uploads
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                document.getElementById('playlistUrl').value = content;
                updateStatus(`‚úì Loaded ${file.name} (${content.length} bytes)`);
            };
            reader.onerror = () => {
                updateStatus('Error: Could not read file');
            };
            reader.readAsText(file);
        }

        // Extract links from input content
        function extractLinksFromInput() {
            const content = document.getElementById('playlistUrl').value;
            if (!content.trim()) {
                updateStatus('Error: No content to parse');
                return;
            }
            
            const urls = parseFileContent(content);
            if (urls.length === 0) {
                updateStatus('Error: No URLs found in content');
                return;
            }
            
            updateStatus(`‚úì Found ${urls.length} URLs. Attempting to load first valid URL...`);
            
            // Try to load the first valid URL
            for (const url of urls) {
                try {
                    loadPlaylistUrl(url);
                    return;
                } catch (e) {
                    continue;
                }
            }
            
            updateStatus('Error: Could not load any of the extracted URLs');
        }

        let hls = null;
        
        function loadPlaylistUrl(url) {
            if (!url) {
                updateStatus('Error: Please enter a playlist URL');
                return;
            }
            
            updateStatus('Loading playlist...');
            
            if (hls) hls.destroy();
            
            const video = document.getElementById('video');
            hls = new Hls({
                maxBufferLength: parseInt(document.getElementById('maxBuffer').value),
                backBufferLength: parseInt(document.getElementById('backBuffer').value),
                liveSyncDurationCount: parseInt(document.getElementById('liveSync').value),
                initialLiveManifestSize: parseInt(document.getElementById('initialSize').value)
            });
            
            hls.loadSource(url);
            hls.attachMedia(video);
            
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                const title = extractTitle(url);
                updateStatus(`‚úì Loaded: ${title} (${hls.levels?.length || '?'} variants)`);
                video.play().catch(() => updateStatus('Ready (click play to start)'));
            });
            
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                    updateStatus('Error: ' + data.response?.reason || 'Failed to load playlist');
                }
            });
        }
        
        function loadPlaylist() {
            const content = document.getElementById('playlistUrl').value.trim();
            
            // If it's a single URL
            if (content.startsWith('http://') || content.startsWith('https://')) {
                const lines = content.split('\n');
                if (lines.length === 1) {
                    loadPlaylistUrl(content);
                    return;
                }
            }
            
            // Otherwise, extract URLs from content
            extractLinksFromInput();
        }
        
        function applyPreset(preset) {
            const presets = {
                'live': { max: 20, back: 45, sync: 3, init: 3 },
                'vod': { max: 60, back: 120, sync: 5, init: 10 },
                'mobile': { max: 15, back: 30, sync: 2, init: 3 },
                'highbw': { max: 90, back: 180, sync: 5, init: 15 }
            };
            
            const p = presets[preset];
            document.getElementById('maxBuffer').value = p.max;
            document.getElementById('backBuffer').value = p.back;
            document.getElementById('liveSync').value = p.sync;
            document.getElementById('initialSize').value = p.init;
            updateConfig();
        }
        
        function updateConfig() {
            const maxBuf = parseInt(document.getElementById('maxBuffer').value);
            const backBuf = parseInt(document.getElementById('backBuffer').value);
            const liveSync = parseInt(document.getElementById('liveSync').value);
            const initSize = parseInt(document.getElementById('initialSize').value);
            
            document.getElementById('maxBufferDisplay').textContent = maxBuf + 's';
            document.getElementById('backBufferDisplay').textContent = backBuf + 's';
            document.getElementById('liveSyncDisplay').textContent = liveSync;
            document.getElementById('initialSizeDisplay').textContent = initSize;
            
            // Update memory estimate (rough)
            const memEst = Math.ceil((maxBuf + backBuf) / 60 * 100) + 100;
            document.getElementById('memEst').textContent = '~' + memEst + 'MB';
            
            // Update startup estimate
            const startupEst = Math.ceil(1000 + (initSize * 200));
            document.getElementById('startupEst').textContent = '~' + startupEst + 'ms';
            
            // Update code example
            const code = `const hls = new Hls({
  maxBufferLength: ${maxBuf},
  backBufferLength: ${backBuf},
  liveSyncDurationCount: ${liveSync},
  initialLiveManifestSize: ${initSize}
});
hls.loadSource('playlist.m3u8');
hls.attachMedia(video);`;
            
            document.getElementById('hlsJsCode').textContent = code;
            
            // Update current config
            const configText = `
‚úì Max Forward Buffer: ${maxBuf}s
‚úì Back Buffer Eviction: ${backBuf}s  
‚úì Live Sync Segments: ${liveSync}
‚úì Initial Manifest Size: ${initSize}
‚úì Estimated Memory: ~${memEst}MB
‚úì Estimated Startup: ~${startupEst}ms
`.trim();
            document.getElementById('currentConfig').textContent = configText;
        }
        
        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        
        function copyConfig() {
            const config = document.getElementById('hlsJsCode').textContent;
            navigator.clipboard.writeText(config).then(() => {
                alert('Configuration copied to clipboard!');
            });
        }
        
        // Initialize on load
        updateConfig();
    </script>
</body>
</html>
